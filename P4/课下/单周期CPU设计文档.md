# 单周期CPU设计文档

## 一、总体架构与功能概览

>   备忘：
>
>   *   所有MUX的选择端都由CU计算，选择端Tunnel命名：xxxSel
>
>   
>
>   
>
>   addu/subu, and/or, sll/sllv/slt, jr, addi/ori/lui, slti, beq/blez, j/jal, sw/sh, lw/lh/lhu
>



各类型指令支持情况：

| Load | Save | Cal_r | Cal_i(16位imm) | B_type | J_Type | Shamt(5位imm) | Other |
| ---- | ---- | ----- | -------------- | ------ | ------ | ------------- | ----- |
| lw   | sw   | addu  | ori            | beq    | jal    | sll           | lui   |
| lh   | sh   | subu  |                |        | jr     |               |       |
| lhu  | sb   | and   |                |        |        |               |       |
| lb   |      | or    |                |        |        |               |       |
| lbu  |      | sllv  |                |        |        |               |       |
|      |      |       |                |        |        |               |       |



**添加指令步骤**：新指令分析 -> 数据通路构建（判断是否需要添加新的数据来源） -> 控制器设计

### 新指令分析

| 阶段                  | 任务 |
| --------------------- | ---- |
| 取指令（对NPC的影响） |      |
| 指令译码              |      |
| 指令执行（ALU）       |      |
| 存储器访问            |      |
| 回写                  |      |



### 数据通路构建

| 阶段     | 模块 | 输入    | Load      | Save      | Cal_r     | Cal_i     | B_type | Shamt | lui | Jal   | Jr |      |      | 综合             |
| -------- | ---- | ------- | --------- | --------- | --------- | --------- | ------ | ----- | ----- | ---- | ---- | ---------------- | ---------------- | ---------------- |
| 取指令   | NPC  | NPCSrc  | PC4       | PC4       | PC4       | PC4       | Imm16  | PC4 | PC4 | Imm26 | RD1 |      |      | PC4 Imm26 RD1    |
|          | PC   | /       | /         | /         | /         | /         | /      | /     | /    | /     | / |      |      | /                |
|          | IM   | /       | /         | /         | /         | /         | /      | /     | /    | /     | / |      |      | /                |
|          |      |         |           |           |           |           |        |       |       |       |      |      |      |                  |
| 译码     | SPLT | /       | /         | /         | /         | /         | /      | /     | /    | /     | / |      |      | /                |
|          | EXT  | Imm16   | Imm16     | Imm16     | /     | Imm16     | Imm16  | / | Imm16 | /     | / |      |      | Imm16            |
|          | GRF  | A1      | rs        | rs        | rs        | rs        | rs     | / | /    | /     | rs |      |      | rs               |
|          |      | A2      | /         | rt        | rt        | /         | rt     | rt | /    | /     | / |      |      | rt               |
|          |      |         |           |           |           |           |        |       |       |       |      |      |      |                  |
| 执行     | ALU  | A       | RD1       | RD1       | RD1       | RD1       | RD1    | / | /   | /     | / |      |      | RD1              |
|          |      | B       | Ext32     | Ext32     | RD2       | Ext32     | RD2    | RD2 | Ext32 | /     | / |      |      | RD2 Ext32        |
|          |      | Shamt   | /         | /         | /         | /         | /      | shamt | /    | /     | / |      |      | shamt |
|          |      |         |           |           |           |           |        |       |       |       |      |      |      |                  |
| 读存储器 | DM   | Address | ALUResult | ALUResult | /         | /         | /      | / | /    | /     | / |      |      | ALUResult        |
|          |      | WD      | /         | RD2       | /         | /         | /      | / | /    | /     | / |      |      | RD2              |
|          |      |         |           |           |           |           |        |       |       |       |      |      |      |                  |
| 回写     | RF   | A3      | rt        | /         | rd        | rt        | /      | rd | rt | ra |/|||rt rd ra|
|          |      | WD      | RD        | /         | ALUResult | ALUResult | /      | ALUResult | ALUResult | PC4   | / |      |      | RD ALUResult PC4 |
|          |      |         |           |           |           |           |        |       |       |       |      |      |      |                  |



### 控制器设计

| 指令 | ALUControl | NPCSel  | WDSel | A3Sel | ALUSrcBSel | EXTOp | DMWr | !RFWr | DataType |
| ---- | ---------- | ------- | ----- | ----- | ---------- | ----- | ---- | ----- | -------- |
| addu | 0000       | 000     | 00    | 00    | 00         | /     | 0    | 0     | 000      |
| subu | 0001       | 000     | 00    | 00    | 00         | /     | 0    | 0     | 000      |
| ori  | 0010       | 000     | 00    | 01    | 01         | 0     | 0    | 0     | 000      |
| lw   | 0000       | 000     | 01    | 01    | 01         | 1     | /    | 0     | 000      |
| sw   | 0000       | 000     | /     | /     | 01         | 1     | 1    | 1     | 000      |
| beq  | 0001       | 000/001 | /     | /     | 00         | 1     | 0    | 1     | 000      |
| jal  | /          | 010     | 10    | 10    | /          | /     | 0    | 0     | 000      |
| lui  | 0100       | 000     | 00    | 01    | 01         | 0     | 0    | 0     | 000      |
| and  | 0011       | 000     | 00    | 00    | 00         | /     | 0    | 0     | 000      |
| or   | 0010       | 000     | 00    | 00    | 00         | /     | 0    | 0     | 000      |
| jr   | /          | 011     | /     | /     | /          | /     | /    | 1     | 000      |
| sll  | 0101       | 000     | 00    | 00    | 00         | /     | /    | 0     | 000      |
| sllv | 0110       | 000     | 00    | 00    | 00         | /     | /    | 0     | 000      |
| lh   | 0000       | 000     | 01    | 01    | 01         | 1     | /    | 0     | 001      |
| lhu  | 0000       | 000     | 01    | 01    | 01         | 1     | /    | 0     | 010      |
| lb   | 0000       | 000     | 01    | 01    | 01         | 1     | /    | 0     | 011      |
| lbu  | 0000       | 000     | 01    | 01    | 01         | 1     | /    | 0     | 100      |
| sh   | 0000       | 000     | /     | /     | 01         | 1     | 1    | 1     | 001      |
| sb   | 0000       | 000     | /     | /     | 01         | 1     | 1    | 1     | 010      |
|      |            |         |       |       |            |       |      |       |          |
| nop  | /          | 000     | /     | /     | /          | /     | /    | /     |          |
|      |            |         |       |       |            |       |      |       |          |



### 功能模块

| 模块                           | 功能               |
| ------------------------------ | ------------------ |
| NPC: Next Program Counter      | 计算下一条指令地址 |
| PC: Program Counter            | 存储当前指令地址   |
| IM: Instruction Memory         | 存储所有指令       |
| SPLT: Split                    | 指令分线器         |
| EXT: Extend                    | 立即数扩展         |
| GRF(RF): General Register File | 32个寄存器         |
| ALU: Arithmetic logic unit     | 算数逻辑单元       |
| DM: Data Memory                | 存储所有数据       |
| CU: Control Unit               | 计算控制信号       |
|                                |                    |
|                                |                    |



## 二、功能模块定义

### NPC

**端口定义**

| 端口   | 输入/输出 | 位宽 | 描述                                                         |
| ------ | --------- | ---- | ------------------------------------------------------------ |
| PC     | I         | 32   | 当前指令地址                                                 |
| Imm26  | I         | 26   | 当前指令的26位立即数                                         |
| RA     | I         | 32   | 当前指令的RS                                                 |
| NPCSel | I         | 3    | NPC计算方式选择信号<br />00：PC+4<br />01：Imm26<<2 + PC + 4<br />10：PC[31:28]\|\|Imm26\|\|00<br />11：RA |
| PC4    | O         | 32   | 当前指令地址+4                                               |
| NPC    | O         | 32   | 下一条指令地址                                               |

**功能定义**

| 编号 | 名称     | 描述                                            |
| ---- | -------- | ----------------------------------------------- |
| 1    | 地址计算 | 根据选择信号NPCSel，计算对应下一条指令的地址NPC |
| 2    | 地址计算 | 计算PC+4，为后续组件提供输入数据                |

### PC

**端口定义**

| 端口  | 输入/输出 | 位宽 | 描述           |
| ----- | --------- | ---- | -------------- |
| DI    | I         | 32   | 下一条指令地址 |
| clk   | I         | 1    | 时钟信号       |
| reset | I         | 1    | 异步复位信号   |
| DO    | O         | 32   | 当前指令地址   |

**功能定义**

| 编号 | 名称     | 描述                              |
| ---- | -------- | --------------------------------- |
| 1    | 复位     | reset有效时，PC异步置为0x00000000 |
| 2    | 地址存储 | 保存并输出当前指令的地址DO        |

### IM

**端口定义**

| 端口    | 输入/输出 | 位宽 | 描述               |
| ------- | --------- | ---- | ------------------ |
| Address | I         | 32   | 当前指令地址       |
| Data    | O         | 32   | 输出当前地址的指令 |

**功能定义**

| 编号 | 名称     | 描述                        |
| ---- | -------- | --------------------------- |
| 1    | 指令存储 | 保存并输入Address对应的指令 |

### SPLT

**端口定义**

| 端口        | 输入/输出 | 位宽 | 描述             |
| ----------- | --------- | ---- | ---------------- |
| Instruction | I         | 32   | 当前待拆分的指令 |
| Op:31_26    | O         | 6    | 操作码           |
| Rs:25_21    | O         | 5    | 寄存器1地址      |
| Rt:20_16    | O         | 5    | 寄存器2地址      |
| Rd:15_11    | O         | 5    | 寄存器3地址      |
| Shamt:10_6  | O         | 5    | 偏移量           |
| Func:5_0    | O         | 6    | 函数码           |
| Imm:15_0    | O         | 16   | 16位立即数       |
| Imm:25_0    | O         | 26   | 26位立即数       |

**功能定义**

| 编号 | 名称 | 描述       |
| ---- | ---- | ---------- |
| 1    | 分线 | 将指令拆分 |

### EXT

**端口定义**

| 端口    | 输入/输出 | 位宽 | 描述                                                 |
| ------- | --------- | ---- | ---------------------------------------------------- |
| Imm16   | I         | 16   | 待扩展的16位立即数                                   |
| Signed? | I         | 1    | 符号扩展类型选择<br />0：无符号扩展<br />1：符号扩展 |
| Ext32   | O         | 32   | 扩展后的16位立即数                                   |

**功能定义**

| 编号 | 名称       | 描述                                  |
| ---- | ---------- | ------------------------------------- |
| 1    | 无符号扩展 | 当Signed?为0时，将Imm16无符号扩展输出 |
| 2    | 符号扩展   | 当Signed?为1时，将Imm16无符号扩展输出 |

### GRF

**端口定义**

| 端口 | 输入/输出 | 位宽 | 描述                                                         |
| ---- | --------- | ---- | ------------------------------------------------------------ |
| A1   | I         | 5    | 指定32个寄存器中的一个，将其中存储的数据读出到RD1            |
| A2   | I         | 5    | 指定32个寄存器中的一个，将其中存储的数据读出到RD2            |
| A3   | I         | 5    | 指定32个寄存器中的一个，作为WD的写入地址                     |
| WD   | I         | 32   | 32位写入数据                                                 |
| we   | I         | 1    | 写使能信号<br />0：禁止向GRF中写入数据<br />1：允许向GRF中写入数据 |
| rst  | I         | 1    | 异步复位信号，将32个寄存器中全部清零<br />0：无效<br />1：复位 |
| RD1  | O         | 32   | 输出A1指定的寄存器的32位数据                                 |
| RD2  | O         | 32   | 输出A2指定的寄存器的32位数据                                 |

**功能定义**

| 编号 | 名称     | 描述                                                    |
| ---- | -------- | ------------------------------------------------------- |
| 1    | 异步复位 | reset为1时，将所有寄存器清零                            |
| 2    | 读数据   | 将A1和A2地址对应的寄存器的值分别通过RD1和RD2读出        |
| 3    | 写数据   | 当we为1且时钟上升沿来临时，将WD写入到A3对应的寄存器内部 |

### ALU

**端口定义**

| 端口       | 输入/输出 | 位宽 | 描述                                                         |
| ---------- | --------- | ---- | ------------------------------------------------------------ |
| SrcA       | I         | 32   | 参与运算的第一个数                                           |
| SrcB       | I         | 32   | 参与运算的第二个数                                           |
| ALUControl | I         | 4    | 决定ALU做何种操作<br />0000：无符号加<br />0001：无符号减<br />0010：按位或<br />0011：按位与<br />0100：将SrcB左移16位<br />0101：将SrcB左移Shamt位 |
| Shamt      | I         | 5    | 偏移量                                                       |
| Zero       | O         | 1    | 减法运算时，两操作数是否相等                                 |
| ALUResult  | O         | 32   | 运算后结果                                                   |

**功能定义**

| 编号 | 名称              | 描述                      |
| ---- | ----------------- | ------------------------- |
| 1    | 无符号加          | ALUResult = SrcA + SrcB   |
| 2    | 无符号减          | ALUResult = SrcA - SrcB   |
| 3    | 按位或            | ALUResult = SrcA \| SrcB  |
| 4    | 按位与            | ALUResult = SrcA & SrcB   |
| 5    | 将SrcB左移16位    | ALUResult = SrcB  << 16   |
| 6    | 将SrcB左移Shamt位 | ALUResult = SrcB << Shamt |

### DM

**端口定义**

| 端口    | 输入/输出 | 位宽 | 描述                                                         |
| ------- | --------- | ---- | ------------------------------------------------------------ |
| clk     | I         | 1    | 时钟信号                                                     |
| Wr      | I         | 1    | 写使能信号<br />0：禁止向DM中写入数据<br />1：允许向DM中写入数据 |
| reset   | I         | 1    | 异步复位信号<br />0：无效<br />1：复位                       |
| Address | I         | 32   | 读取或写入信号地址                                           |
| WD      | I         | 32   | 32位写入数据                                                 |
| RD      | O         | 32   | 32位读出数据                                                 |

**功能定义**

| 编号 | 名称     | 描述                                                         |
| ---- | -------- | ------------------------------------------------------------ |
| 1    | 异步复位 | 当reset为1时，DM中所有数据清零                               |
| 2    | 写入数据 | 当Wr有效时，时钟上升沿来临时，WD中数据写入A对应的DM地址Address中 |
| 3    | 读出数据 | RD始终读出Address对应的DM地址中的值                          |

### CU

**端口定义**

| 端口       | 输入/输出 | 位宽 | 描述              |
| ---------- | --------- | ---- | ----------------- |
| Opcode     | I         | 6    | 6位控制信号       |
| Func       | I         | 6    | 6位控制信号       |
| Zero       | I         | 1    | 两操作数是否相等  |
| NPCSel     | O         | 3    | NPC的选择信号     |
| EXTOp      | O         | 1    | EXT的选择信号     |
| ALUControl | O         | 4    | ALU的控制信号     |
| DMWr       | O         | 1    | DM写使能信号      |
| ALUSrcBSel | O         | 1    | SrcB的选择信号    |
| RFWr       | O         | 1    | GRF写使能信号     |
| WDSel      | O         | 2    | GRF的WD的选择信号 |
| A3Sel      | O         | 2    | GRF的A3的选择信号 |

**功能定义**

| 编号 | 名称         | 描述                             |
| ---- | ------------ | -------------------------------- |
| 1    | 控制信号生成 | 判断指令类型并产生对应的控制信号 |



## 三、测试方案

评测方案：python生成MIPS代码 + 自动对拍测试

*   python生成MIPS代码：

    对每条指令进行覆盖率测试，覆盖所有寄存器、边缘极值等。

    ```python
    import random
    
    for i in range(10):
    	imm =  random.randint(0,1000)
    	imm = imm * 2
    	print("ori ${}, $0, {}" .format(i, imm))
    
    for i in range(10):
    	imm =  random.randint(0,20)
    
    	if i % 2:
    		imm = imm * 2
    		print("sh ${}, {}($0)" .format(i, imm))
    	else:
    		imm = imm * 1
    		print("sb ${}, {}($0)".format(i, imm))
    
    for i in range(10):
    	imm =  random.randint(0,20)
    	if i % 2:
    		imm = imm * 1
    		print("lbu ${}, {}($0)" .format(i, imm))
    	else:
    		imm = imm * 2
    		print("lhu ${}, {}($0)".format(i, imm))
    ```

*   自动对拍测试：[uanu2002/BUAA-CO-CPU-Judge](https://github.com/uanu2002/BUAA-CO-CPU-Judge)

    调用Mars编译MIPS代码，并将结果载入值Logisim电路中的ROM，分别单步运行MIPS和Logisim，并对单步输出（GRF和DM操作、输出引脚）进行记录，运行结束后对输出进行对拍。



## 四、思考题

1.  上面我们介绍了通过 FSM 理解单周期 CPU 的基本方法。请大家指出单周期 CPU 所用到的模块中，哪些发挥状态存储功能，哪些发挥状态转移功能。
    答：

    *   状态存储
        *   DM
        *   GRF
        *   IFU(PC)
    *   状态转移
        *   NPC
        *   CU
        *   ALU

1.  现在我们的模块中 IM 使用 ROM， DM 使用 RAM， GRF 使用 Register，这种做法合理吗？ 请给出分析，若有改进意见也请一并给出。
    答：合理。
    IM只需要被读取，采用只有读取功能的ROM，避免对存储指令的修改。
    DM需要读取和写入，但每个周期内只会进行其中的一个操作，因此可以采用支持读写的单一地址的RAM。如果使用寄存器也可以实现，但DM需要较大的空间，会造成成本的提高。
    GRF需要读取和写入，且每个周期内可能同时存在两个操作，因此使用Register可以方便读写，同时满足较高的读写速度要求。
    无改进意见。
    
3.  在上述提示的模块之外，你是否在实际实现时设计了其他的模块？如果是的话，请给出介绍和设计的思路。
    答：

    | 模块 | 作用               | 设计思路                               | 实现       |
    | ---- | ------------------ | -------------------------------------- | ---------- |
    | NPC  | 计算下一条指令地址 | 低内聚高耦合，作为PC计算相关唯一的模块 | 多路选择器 |
    | SPLT | 将指令分解         | 外观简化，便于顶层设计                 | 分线器     |

    

4.  事实上，实现 `nop` 空指令，我们并不需要将它加入控制信号真值表，为什么？
    答：当载入`nop`指令时，整个CPU只会执行`PC<=PC+4`的操作，不会影响最终结果。
    或者可以将`nop`看做`sll`指令（如果实现了该指令），`shamt`为`0`，除PC外不会产生任何影响。

5.  上文提到，MARS 不能导出 PC 与 DM 起始地址均为 0 的机器码。实际上，可以避免手工修改的麻烦。请查阅相关资料进行了解，并阐释为了解决这个问题，你最终采用的方法。
    答：给DM增加片选信号。
    设置PC起始地址为`0x0000`时，DM的起始地址则为`0x3000`，与我们CPU中DM的起始地址`0x0000`矛盾。可以通过先检测DM的输入信号，如果地址是从`0x3000`开始，则通过片选信号将`0x3000`映射到`0x0000`后作为输入地址。

6.  阅读 Pre 的 [“MIPS 指令集及汇编语言”](http://cscore.buaa.edu.cn/tutorial/mips/mips-6/mips6-1/) 一节中给出的测试样例，评价其强度（可从各个指令的覆盖情况，单一指令各种行为的覆盖情况等方面分析），并指出具体的不足之处。
    答：该测试样例覆盖了CPU支持的所有指令，但是在单一指令各种行为的覆盖方面仍有不足。

    例如，`ori`指令的测试只覆盖了立即数的正数情况，没有覆盖负数、零的情况。`sw`和`lw`指令的测试没有覆盖 `offset` 为负的情况，此外虽然覆盖了存取多个寄存器的情况，但是没有对每个寄存器都进行测试，覆盖度不足。`beq`指令的测试没有覆盖向前跳转，连续跳转等情况。







